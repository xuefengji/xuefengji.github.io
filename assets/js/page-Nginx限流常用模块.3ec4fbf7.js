(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{654:function(s,t,n){"use strict";n.r(t);var a=n(1),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"nginx-限流常用模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-限流常用模块"}},[s._v("#")]),s._v(" Nginx 限流常用模块")]),s._v(" "),n("p",[s._v("限流是一个比较常见的需求，它可以限制某个用户在一定时间内产生的 HTTP 请求数。常用于安全方面，通过限制请求速度来防止外部暴力扫描，或者减慢暴力密码破解攻击，可以结合日志标记出目标 URL 来帮助防范 DDoS 攻击，也可以解决流量突发的问题（如整点活动）。")]),s._v(" "),n("h2",{attrs:{id:"模块介绍"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#模块介绍"}},[s._v("#")]),s._v(" 模块介绍")]),s._v(" "),n("p",[s._v("Nginx 有两个限流常用模块：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("ngx_http_limit_conn_module")]),s._v("：该模块用于限制并发连接数\n"),n("ul",[n("li",[s._v("在配置文件中，使用 "),n("code",[s._v("limit_conn_zone")]),s._v(" 和 "),n("code",[s._v("limit_conn")]),s._v(" 指令")])])]),s._v(" "),n("li",[n("code",[s._v("ngx_http_limit_req_module")]),s._v("：该模块用于限制一段时间内同一 IP 的访问频率\n"),n("ul",[n("li",[s._v("在配置文件中，使用 "),n("code",[s._v("limit_req_zone")]),s._v(" 和 "),n("code",[s._v("limit_req")]),s._v(" 指令")])])])]),s._v(" "),n("p",[s._v("下面是配置案例。")]),s._v(" "),n("h2",{attrs:{id:"限制并发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#限制并发"}},[s._v("#")]),s._v(" 限制并发")]),s._v(" "),n("p",[s._v("限制 IP 并发数，也是说限制同一个 IP 同时连接服务器的数量。可以防止一瞬间的并发访问过高导致服务器崩掉。")]),s._v(" "),n("h3",{attrs:{id:"_1-添加-limit-conn-zone"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加-limit-conn-zone"}},[s._v("#")]),s._v(" 1. 添加 "),n("code",[s._v("limit_conn_zone")])]),s._v(" "),n("p",[s._v("这个变量只能配置在 "),n("code",[s._v("http")]),s._v(" 中。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("http "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一个名为 addr 的 limit_req_zone 用来存储 session，大小是 10M 内存")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以 $binary_remote_addr 为 key")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx 1.18 以后用 limit_conn_zone 替换了 limit_conn")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 且只能放在 http{} 代码段")]),s._v("\n    limit_conn_zone "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$binary_remote_addr")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("zone")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("addr:10m"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n    include /usr/local/nginx/conf/vhosts/*.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h3",{attrs:{id:"_2-添加-limit-conn"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加-limit-conn"}},[s._v("#")]),s._v(" 2. 添加 "),n("code",[s._v("limit_conn")])]),s._v(" "),n("p",[s._v("这个变量可以配置在 "),n("code",[s._v("http")]),s._v("，"),n("code",[s._v("server")]),s._v("，"),n("code",[s._v("location")]),s._v(" 中的任一位置。因为我这里只限制一个站点，所以添加到 "),n("code",[s._v("server")]),s._v(" 里面。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n    limit_conn addr "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接数限制")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置给定键值的共享内存区域和允许的最大连接数。超出此限制时，服务器将返回 503（服务临时不可用）错误.")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果区域存储空间不足，服务器将返回503（服务临时不可用）错误")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("上面的配置能达到的效果就是，一瞬间访问的时候，只会有 10 个 IP 能得到响应，后面的 IP 直接就返回 503 状态。")]),s._v(" "),n("h2",{attrs:{id:"限制-ip-访问频率"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#限制-ip-访问频率"}},[s._v("#")]),s._v(" 限制 IP 访问频率")]),s._v(" "),n("p",[s._v("限制同一个 IP 在一段时间里连接服务器的次数，可以一定程度上防止类似 CC 这种快速频率请求的攻击。")]),s._v(" "),n("h3",{attrs:{id:"_1-添加-limit-req-zone"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加-limit-req-zone"}},[s._v("#")]),s._v(" 1. 添加 "),n("code",[s._v("limit_req_zone")])]),s._v(" "),n("p",[s._v("这个变量只能配置在 "),n("code",[s._v("http")]),s._v(" 中。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("http "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 定义一个名为 allips 的 limit_req_zone 用来存储 session，大小是 10M 内存，")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以 $binary_remote_addr 为 key，限制平均每秒的请求为 20 个，")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1M 能存储 16000 个状态，rate 的值必须为整数，")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果限制两秒钟一个请求，可以设置成 30r/m")]),s._v("\n    limit_req_zone "),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$binary_remote_addr")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("zone")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("allips:10m "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rate")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("20r/s"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n    include /usr/local/nginx/conf/vhosts/*.conf"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h3",{attrs:{id:"_2-添加-limit-req"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加-limit-req"}},[s._v("#")]),s._v(" 2. 添加 "),n("code",[s._v("limit_req")])]),s._v(" "),n("p",[s._v("这个变量可以配置在 "),n("code",[s._v("http")]),s._v("，"),n("code",[s._v("server")]),s._v("，"),n("code",[s._v("location")]),s._v(" 中的任一位置。因为我这里只限制一个站点，所以添加到 "),n("code",[s._v("server")]),s._v(" 里面。")]),s._v(" "),n("div",{staticClass:"language-bash line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[s._v("server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 限制每 IP 每秒不超过 20 个请求，漏桶数 burst 为 5")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# brust 的意思就是，如果第 1、2、3、4 秒请求为 19 个，")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第 5 秒的请求为 25 个是被允许的。")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 但是如果第 1 秒就 25 个请求，第 2 秒超过 20 的请求返回 503 错误。")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nodelay，如果不设置该选项，严格使用平均速率限制请求数，")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第 1 秒 25 个请求时，5 个请求放到第 2 秒执行，")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置 nodelay，25 个请求将在第 1 秒执行。")]),s._v("\n    limit_req "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("zone")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("allips "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("burst")]),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" nodelay"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("此时能达到的效果，同一个 IP 在一秒钟只能获得 20 个访问，超过 20 个请求，后面的也是直接返回 503。")]),s._v(" "),n("h2",{attrs:{id:"限制并发-限制-ip-访问频率"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#限制并发-限制-ip-访问频率"}},[s._v("#")]),s._v(" 限制并发 + 限制 IP 访问频率")]),s._v(" "),n("p",[s._v("上面的两个配置加在一起就可以做到："),n("strong",[s._v("一秒只有 10 个连接，每个连接只能发送 20 个请求")]),s._v("。")]),s._v(" "),n("p",[s._v("注意：对 request 的访问限制，一定要注意数量的配置，否则一不小心就会 503（ERR_ABORTED 503 (Service Temporarily Unavailable)），这会导致很多静态资源类型被拦截，使得页面加载不完整。")]),s._v(" "),n("h2",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[s._v("通过 Nginx 的这两个模块实现限流是挺好用的功能，但是这两个配置也不是绝对安全，只要有足够的耐心来尝试，摸索出间接等待的时长，一样可以绕过这些校验，所以最好的方式还是在服务端做校验，防止不法分子对后台端口进行疯狂调用。")]),s._v(" "),n("h2",{attrs:{id:"参考资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html",title:"Module ngx_http_limit_conn_module",target:"_blank",rel:"noopener noreferrer"}},[s._v("Module ngx_http_limit_conn_module"),n("OutboundLink")],1)]),s._v(" "),n("li",[n("a",{attrs:{href:"https://nginx.org/en/docs/http/ngx_http_limit_req_module.html",title:"Module ngx_http_limit_req_module",target:"_blank",rel:"noopener noreferrer"}},[s._v("Module ngx_http_limit_req_module"),n("OutboundLink")],1)])]),s._v(" "),n("p",[s._v("（完）")])])}),[],!1,null,null,null);t.default=e.exports}}]);