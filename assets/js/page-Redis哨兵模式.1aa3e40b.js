(window.webpackJsonp=window.webpackJsonp||[]).push([[118],{1168:function(s,n,e){"use strict";e.r(n);var t=e(1),a=Object(t.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis-哨兵模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-哨兵模式"}},[s._v("#")]),s._v(" Redis 哨兵模式")]),s._v(" "),t("p",[s._v("前面学习到主从切换技术的方法：")]),s._v(" "),t("ul",[t("li",[s._v("当主服务器宕机后，需要手动把一台从服务器切换为主服务器")]),s._v(" "),t("li",[s._v("需要人工干预，费事费力，还会造成一段时间内服务不可用")])]),s._v(" "),t("p",[s._v("这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式")]),s._v(" "),t("h2",{attrs:{id:"什么是哨兵模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是哨兵模式"}},[s._v("#")]),s._v(" 什么是哨兵模式")]),s._v(" "),t("ul",[t("li",[s._v("哨兵模式是一种特殊的模式")]),s._v(" "),t("li",[s._v("哨兵是一个独立的进程，会独立运行")]),s._v(" "),t("li",[s._v("哨兵通过发送命令，等待 Redis 服务器响应，从而监控运行的多个 Redis 实例")])]),s._v(" "),t("p",[t("img",{attrs:{src:e(623),alt:"sentiel"}})]),s._v(" "),t("p",[s._v("哨兵的作用：")]),s._v(" "),t("ul",[t("li",[s._v("通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器")]),s._v(" "),t("li",[s._v("当哨兵监测到 master 宕机，会自动将 slave 切换成 master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它们切换主机")])]),s._v(" "),t("p",[s._v("一个哨兵进程对 Redis 服务器进行监控，可能会出现问题，可以使用多个哨兵进行监控")]),s._v(" "),t("p",[s._v("各个哨兵之间还会进行监控，这样就形成了多哨兵模式")]),s._v(" "),t("p",[t("img",{attrs:{src:e(624),alt:"sentiel"}})]),s._v(" "),t("p",[s._v("故障切换（failover）的过程:")]),s._v(" "),t("ul",[t("li",[s._v("主服务器宕机，哨兵1 先检测到这个结果，系统并不会马上进行 failover 过程")]),s._v(" "),t("li",[s._v("仅仅是哨兵1 主观的认为主服务器不可用，这个现象成为"),t("strong",[s._v("主观下线")])]),s._v(" "),t("li",[s._v("当其他哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行 failover 操作")]),s._v(" "),t("li",[s._v("切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为"),t("strong",[s._v("客观下线")])])]),s._v(" "),t("h2",{attrs:{id:"哨兵模式配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵模式配置"}},[s._v("#")]),s._v(" 哨兵模式配置")]),s._v(" "),t("p",[s._v("以一主二从为例配置")]),s._v(" "),t("p",[t("strong",[s._v("配置哨兵配置文件 sentinel.conf")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel monitor 监控的名称 监控的主机 端口号 1")]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1: 表示主机挂了，slave 进行投票，投票最高的成为主机")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("strong",[s._v("启动哨兵")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-sentinel config/sentinel.conf \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:e(625),alt:"sentinel"}})]),s._v(" "),t("p",[s._v("断开主机，哨兵日志：")]),s._v(" "),t("p",[t("img",{attrs:{src:e(626),alt:"sentinel"}})]),s._v(" "),t("h2",{attrs:{id:"哨兵模式优缺点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵模式优缺点"}},[s._v("#")]),s._v(" 哨兵模式优缺点")]),s._v(" "),t("p",[t("strong",[s._v("优点")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("哨兵集群，基于主从复制模式，所有主从复制的优点，它都有")]),s._v(" "),t("li",[s._v("主从可以切换，故障可以转移，系统的可用性更好")]),s._v(" "),t("li",[s._v("哨兵模式是主从模式的升级，手动到自动，更加健壮")])]),s._v(" "),t("p",[t("strong",[s._v("缺点")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("Redis 不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦")]),s._v(" "),t("li",[s._v("实现哨兵模式的配置其实是很麻烦的，里面有很多配置项")])]),s._v(" "),t("h2",{attrs:{id:"哨兵模式的全部配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#哨兵模式的全部配置"}},[s._v("#")]),s._v(" 哨兵模式的全部配置")]),s._v(" "),t("p",[s._v("完整的哨兵模式配置文件 sentinel.conf")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Example sentinel.conf")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 哨兵sentinel实例运行的端口 默认26379")]),s._v("\nport "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 哨兵sentinel的工作目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v(" /tmp\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 哨兵sentinel监控的redis主节点的 ip port ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# master-name  可以自己命名的主节点名字 只能由字母A-z、数字0-9 、这三个字符".-_"组成')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# quorum 当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel monitor <master-name> <ip> <redis-port> <quorum>")]),s._v("\nsentinel monitor mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当在Redis实例中开启了requirepass foobared 授权密码 这样所有连接Redis实例的客户端都要提供密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置哨兵sentinel 连接主从的密码 注意必须为主从设置一样的验证密码")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel auth-pass <master-name> <password>")]),s._v("\nsentinel auth-pass mymaster MySUPER--secret-0123passw0rd\n \n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定多少毫秒之后 主节点没有应答哨兵sentinel 此时 哨兵主观上认为主节点下线 默认30秒")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel down-after-milliseconds <master-name> <milliseconds>")]),s._v("\nsentinel down-after-milliseconds mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，")]),s._v("\n这个数字越小，完成failover所需的时间就越长，\n但是如果这个数字越大，就意味着越 多的slave因为replication而不可用\n可以通过将这个值设为 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 来保证每次只有一个slave 处于不能处理命令请求的状态\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel parallel-syncs <master-name> <numslaves>")]),s._v("\nsentinel parallel-syncs mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n \n \n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 故障转移的超时时间 failover-timeout 可以用在以下这些方面：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#1. 同一个sentinel对同一个master两次failover之间的间隔时间")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#2. 当一个slave从一个错误的master那里同步数据开始计算时间直到slave被纠正为向正确的master那里同步数据时")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#3.当想要取消一个正在进行的failover所需要的时间  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#4.当进行failover时，配置所有slaves指向新的master所需的最大时间不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认三分钟")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel failover-timeout <master-name> <milliseconds>")]),s._v("\nsentinel failover-timeout mymaster "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SCRIPTS EXECUTION")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#对于脚本的运行结果有以下规则：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行")]),s._v("\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息调用该脚本时，将传给脚本两个参数，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#一个是事件的类型，")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#一个是事件的描述")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#通知脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel notification-script <master-name> <script-path>")]),s._v("\n  sentinel notification-script mymaster /var/redis/notify.sh\n \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 客户端重新配置主节点参数脚本")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下参数将会在调用脚本时传给脚本:")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port>")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 目前<state>总是“failover”,")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# <role>是“leader”或者“observer”中的一个 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个脚本应该是通用的，能被多次调用，不是针对性的")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sentinel client-reconfig-script <master-name> <script-path>")]),s._v("\nsentinel client-reconfig-script mymaster /var/redis/reconfig.sh\n\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br")])]),t("p",[s._v("（完）")])])}),[],!1,null,null,null);n.default=a.exports},623:function(s,n,e){s.exports=e.p+"assets/img/sentinel1.b263555d.png"},624:function(s,n,e){s.exports=e.p+"assets/img/sentinel2.92313176.png"},625:function(s,n,e){s.exports=e.p+"assets/img/sentinel3.bfd7fff4.png"},626:function(s,n,e){s.exports=e.p+"assets/img/sentinel5.9d75e16e.png"}}]);