(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{498:function(s,t,a){"use strict";a.r(t);var n=a(1),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"使用-fabric-执行-ssh"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-fabric-执行-ssh"}},[s._v("#")]),s._v(" 使用 Fabric 执行 SSH")]),s._v(" "),a("h2",{attrs:{id:"关于-fabric"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于-fabric"}},[s._v("#")]),s._v(" 关于 Fabric")]),s._v(" "),a("p",[s._v("Fabric 是 Python 库中的一个模块，它是基于 Paramiko 的基础上做了一层更高的封装，操作起来更加方便。我们可以用它通过网络进行系统管理和应用程序部署，也可以通过 SSH 执行 Shell 命令。")]),s._v(" "),a("p",[s._v("由于 Fabric 是 Python 的一个第三方库，首先需要安装它：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" pip "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" fabric\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("blockquote",[a("p",[s._v("题外话：曾经有一段时间 Fabric 只支持到 Python2，所以有人 Fork 官方仓库后改写成了"),a("a",{attrs:{href:"https://github.com/mathiasertl/fabric/",target:"_blank",rel:"noopener noreferrer"}},[s._v("支持 Python3 的版本"),a("OutboundLink")],1),s._v("，也就是网上大部分教程通过 "),a("code",[s._v("pip install fabric3")]),s._v(" 安装的包。"),a("br"),s._v("\n后来 "),a("a",{attrs:{href:"https://github.com/fabric/fabric/",target:"_blank",rel:"noopener noreferrer"}},[s._v("fabric 官方"),a("OutboundLink")],1),s._v("对 Python3 做了支持，而后 Fabric3 的作者也在 README 中加了 deprecated 标识，意为不再维护。"),a("br"),s._v("\n所以尽管 Fabric3 比较好用，大部分网上的教程和书籍也都是基于它在开发，但处于稳定性和持续维护性角度考虑，我在 Python3 中将继续沿用官方版本的 Fabric。"),a("br"),s._v("\n关于三者的区别："),a("a",{attrs:{href:"https://github.com/fabric/fabric/issues/1791",target:"_blank",rel:"noopener noreferrer"}},[s._v("Clarify fabric vs fabric2 vs fabric3 differences"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"一个简单的例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一个简单的例子"}},[s._v("#")]),s._v(" 一个简单的例子")]),s._v(" "),a("p",[s._v("下面是一个使用 Fabric 连接远程设备的示例程序（"),a("a",{attrs:{href:"https://github.com/wenyuan/practice-in-python/blob/main/devops-case/fabric_example.py",target:"_blank",rel:"noopener noreferrer"}},[a("code",[s._v("fabric_example.py")]),a("OutboundLink")],1),s._v("）：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/usr/bin/env python")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -*- coding: utf-8 -*-")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Connection\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" paramiko "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" AuthenticationException\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("do_ssh")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        client "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" connect_kwargs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行操作")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" command "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            res "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("command"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" hide"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("close"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("except")]),s._v(" AuthenticationException"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{host} 密码错误'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("except")]),s._v(" Exception "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("as")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("repr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"__main__"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    host "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.10.x'")]),s._v("\n    username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'admin'")]),s._v("\n    password "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),s._v("\n    commands "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pwd'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ls'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    do_ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[s._v("Fabric 模块里上面代码中用到的方法介绍：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("Connection")]),s._v(" 类：用于创建连接。")]),s._v(" "),a("li",[a("code",[s._v("run()")]),s._v("：该方法可在连接的服务器上运行 Shell 命令。如果需要用管理员权限，则需替换成 "),a("code",[s._v("sudo()")]),s._v(" 方法；如果要在本地执行 Shell 命令，则需替换成 "),a("code",[s._v("local()")]),s._v(" 方法。\n"),a("ul",[a("li",[s._v("参数 "),a("code",[s._v("warn")]),s._v("：默认为 "),a("code",[s._v("False")]),s._v("，默认情况下会因为 Shell 命令的错误输出而抛错, 也就是直接抛出 "),a("code",[s._v("stderr")]),s._v("。如果设为 "),a("code",[s._v("True")]),s._v(", 就会将 Shell 命令的错误输出写到 Result 对象的 "),a("code",[s._v("stderr")]),s._v(" 内。")]),s._v(" "),a("li",[s._v("参数 "),a("code",[s._v("hide")]),s._v("：默认为 "),a("code",[s._v("False")]),s._v("，默认情况下将远程的输出信息在当前命令行输出。为 "),a("code",[s._v("True")]),s._v(" 时，则不会输出。但不论是什么, 都不会影响 Result 对象的 "),a("code",[s._v("stdout")]),s._v(" 和 "),a("code",[s._v("stderr")]),s._v(" 结果，还可以只隐藏 "),a("code",[s._v("stdout")]),s._v(" 或 "),a("code",[s._v("stderr")]),s._v("。")]),s._v(" "),a("li",[s._v("参数 "),a("code",[s._v("watchers")]),s._v("：传入的是一个包含诺干 Responder 实例的列表。当需要运行交互式的命令时，可以用 Responder 对象来匹配输出，并写入输入，做自动化部署时很实用。")]),s._v(" "),a("li",[s._v("参数 "),a("code",[s._v("pty")]),s._v("：默认为 "),a("code",[s._v("True")]),s._v("，这个参数最好别动，不然输出内容可能会混乱。")])])])]),s._v(" "),a("p",[s._v("关于 "),a("code",[s._v("run()")]),s._v(" 的输出结果：")]),s._v(" "),a("p",[s._v("执行 Connection 类的 "),a("code",[s._v("run()")]),s._v(" 方法后，直接输出的是一个 fabric.runners.Result 类，我们可以把其中的信息解析出来：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /home/admin")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exited"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ok"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# True")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("failed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# False")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("command"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pwd")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 192.xx.xx.xx")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"命令行用法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令行用法"}},[s._v("#")]),s._v(" 命令行用法")]),s._v(" "),a("p",[s._v("上例代码可写在任意的 "),a("code",[s._v(".py")]),s._v(" 脚本中，然后运行该脚本，或者稍微封装下再导入到其它脚本中使用。")]),s._v(" "),a("p",[s._v("另外，Fabric 还是个命令行工具，可以通过 "),a("code",[s._v("fab")]),s._v(" 命令来执行任务。如下代码示例：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文件名：fabfile.py")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Connection\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" task\n\nhost_ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.10.xx'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器地址")]),s._v("\nuser_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'root'")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器用户名")]),s._v("\npassword "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'******'")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器密码")]),s._v("\ncmd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'date'")]),s._v("               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Shell 命令，查询服务器上的时间")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@task")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n    Get date from remote host.\n    """')]),s._v("\n    con "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host_ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" connect_kwargs"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'password'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    result "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" con"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" hide"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 只打印时间")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("解释一下，需要注意的关键点有：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("fabfile.py")]),s._v(" 文件名：入口代码的脚本名必须用这个名字")]),s._v(" "),a("li",[a("code",[s._v("@task")]),s._v(" 装饰器：需要从 fabric 中引入这个装饰器，它是对 invoke 的 "),a("code",[s._v("@task")]),s._v(" 装饰器的封装，实际用法跟 invoke 一样（注意：它也需要有上下文参数 "),a("code",[s._v("c")]),s._v("，但实际上它并没有在代码块中使用，而是用了 Connection 类的实例）")])]),s._v(" "),a("p",[s._v("然后，在该脚本同级目录的命令行窗口中，可以查看和执行相应的任务：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" fab -l\nAvailable tasks:\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("   Get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" from remote host.\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" fab "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nFri Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":10:24 CST "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("执行 "),a("code",[s._v("fab --help")]),s._v("，可以看到该命令支持的所有参数与解释：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("--prompt-for-login-password")]),s._v("：令程序在命令行中输入 SSH 登录密码（上例在代码中指定了 connect_kwargs.password 参数，若用此选项，可要求在执行时再手工输入密码）")]),s._v(" "),a("li",[a("code",[s._v("--prompt-for-passphrase")]),s._v("：令程序在命令行中输入 SSH 私钥加密文件的路径")]),s._v(" "),a("li",[a("code",[s._v("-H")]),s._v(" 或 "),a("code",[s._v("--hosts")]),s._v("：指定要连接的 host 名")]),s._v(" "),a("li",[a("code",[s._v("-i")]),s._v(" 或 "),a("code",[s._v("--identity")]),s._v("：指定 SSH 连接所用的私钥文件")]),s._v(" "),a("li",[a("code",[s._v("-S")]),s._v(" 或 "),a("code",[s._v("--ssh-config")]),s._v("：指定运行时要加载的 SSH 配置文件")])]),s._v(" "),a("p",[s._v("关于 Fabric 的命令行接口，更多内容可"),a("a",{attrs:{href:"https://docs.fabfile.org/en/2.5/cli.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("查看文档"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"交互式操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#交互式操作"}},[s._v("#")]),s._v(" 交互式操作")]),s._v(" "),a("p",[s._v("上面的示例程序我们通过 Fabric 模块连接了一台远程服务器，执行命令后打印了输出结果。")]),s._v(" "),a("p",[s._v("有时候远程服务器上若有交互式提示，要求输入密码或 yes 之类的信息，这就要求 Fabric 能够监听并作出回应。")]),s._v(" "),a("p",[s._v("以下是一个简单示例。引入 invoke 的 Responder，初始化内容是一个正则字符串和回应信息，最后赋值给 watchers 参数：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" invoke "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Responder\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Connection\nc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'host'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nsudopass "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Responder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n     pattern"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("r'\\[sudo\\] password:'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n     response"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mypassword\\n'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sudo whoami'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" pty"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" watchers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("sudopass"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h2",{attrs:{id:"传输文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#传输文件"}},[s._v("#")]),s._v(" 传输文件")]),s._v(" "),a("p",[s._v("本地与服务器间的文件传输是常见用法。Fabric 在这方面做了很好的封装，Connection 类中有以下两个方法可用：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("get(*args, **kwargs)")]),s._v("：拉取远端文件到本地文件系统或类文件（file-like）对象")]),s._v(" "),a("li",[a("code",[s._v("put(*args, **kwargs)")]),s._v("：推送本地文件或类文件对象到远端文件系统")])]),s._v(" "),a("p",[s._v("在已建立连接的情况下，示例：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# (略)")]),s._v("\ncon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/123.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ncon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("put"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/test.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("第一个参数指的是要传输的源文件，第二个参数是要传输的目的地，可以指定成文件名或者文件夹（为空或 "),a("code",[s._v("None")]),s._v(" 时，使用默认路径）：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# (略)")]),s._v("\ncon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/123.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为空时，使用默认路径")]),s._v("\ncon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("put"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定路径 /opt/")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("code",[s._v("get()")]),s._v(" 方法的默认存储路径是 "),a("code",[s._v("os.getcwd()")]),s._v(" ，而 "),a("code",[s._v("put()")]),s._v(" 方法的默认存储路径是 "),a("code",[s._v("home")]),s._v(" 目录。")]),s._v(" "),a("h2",{attrs:{id:"服务器批量操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务器批量操作"}},[s._v("#")]),s._v(" 服务器批量操作")]),s._v(" "),a("p",[s._v("对于服务器集群的批量操作，最简单的实现方法是用 for 循环，然后逐一建立 connection 和执行操作，类似这样：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" host "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    result "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'uname -s'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("但有时候，这样的方案会存在问题：")]),s._v(" "),a("ul",[a("li",[s._v("如果存在多组不同的服务器集群，需要执行不同操作，那么需要写很多 for 循环")]),s._v(" "),a("li",[s._v("如果想把每组操作的结果聚合起来（例如字典形式，key-主机，value-结果），还得在 for 循环之外添加额外的操作")]),s._v(" "),a("li",[s._v("for 循环是顺序同步执行的，效率太低，而且缺乏异常处理机制（若中间出现异常，会导致跳出后续操作）")])]),s._v(" "),a("p",[s._v("对于这些问题，Fabric 提出了 Group 的概念，可将一组主机定义成一个 Group，它的 API 方法跟 Connection 一样，即一个 Group 可简化地视为一个 Connection。")]),s._v(" "),a("p",[s._v("然后，开发者只需要简单地操作这个 Group，最后得到一个结果集即可，减少了自己在异常处理及执行顺序上的工作。")]),s._v(" "),a("p",[s._v("Fabric 提供了一个 fabric.group.Group 基类，并由其派生出两个子类，区别是：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("SerialGroup(hosts, **kwargs)")]),s._v("：按串行方式执行操作")]),s._v(" "),a("li",[a("code",[s._v("ThreadingGroup(hosts, **kwargs)")]),s._v("：按并发方式执行操作")])]),s._v(" "),a("p",[s._v("Group 的类型决定了主机集群的操作方式，我们只需要做出选择即可。然后，它们的执行结果是一个 fabric.group.GroupResult 类，它是 dict 的子类，存储了每个主机 connection 及其执行结果的对应关系。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" SerialGroup\nresults "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" SerialGroup"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'uname -s'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("results"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("GroupResult"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Connection "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server1'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("CommandResult "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'uname -s'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Connection "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server2'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("CommandResult "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'uname -s'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Connection "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'server3'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("CommandResult "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'uname -s'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("另外，GroupResult 还提供了 failed 与 succeeded 两个属性，可以取出失败/成功的子集。由此，也可以方便地批量进行二次操作。"),a("a",{attrs:{href:"https://docs.fabfile.org/en/2.5/api/group.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"身份认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#身份认证"}},[s._v("#")]),s._v(" 身份认证")]),s._v(" "),a("p",[s._v("Fabric 使用 SSH 协议来建立远程会话，它是一种相对安全的基于应用层的加密传输协议。")]),s._v(" "),a("p",[s._v("基本来说，它有两种级别的安全认证方式：")]),s._v(" "),a("ul",[a("li",[s._v("基于口令的身份认证：使用账号与密码来登录远程主机，安全性较低，容易受到「中间人」攻击。")]),s._v(" "),a("li",[s._v("基于密钥的身份认证：使用密钥对方式（公钥放服务端，私钥放客户端），不会受到「中间人」攻击，但登录耗时较长。")])]),s._v(" "),a("p",[s._v("前面在举例时，我们用了第一种方式，即通过指定 "),a("code",[s._v("connect_kwargs.password")]),s._v(" 参数，使用口令来登录。")]),s._v(" "),a("p",[s._v("Fabric 当然也支持采用第二种方式，有三种方法来指定私钥文件的路径，优先级如下：")]),s._v(" "),a("ul",[a("li",[s._v("优先查找 "),a("code",[s._v("connect_kwargs.key_filename")]),s._v(" 参数，找到则用作私钥；")]),s._v(" "),a("li",[s._v("其次查找命令行用法的 "),a("code",[s._v("--identify")]),s._v(" 选项；")]),s._v(" "),a("li",[s._v("最后默认使用操作系统的 "),a("code",[s._v("ssh_config")]),s._v(" 文件中的 "),a("code",[s._v("IdentityFile")]),s._v(" 的值。")])]),s._v(" "),a("p",[s._v("如果私钥文件本身还被加密过，则需要使用 "),a("code",[s._v("connect_kwargs.passphrase")]),s._v(" 参数。")]),s._v(" "),a("h2",{attrs:{id:"配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[s._v("#")]),s._v(" 配置文件")]),s._v(" "),a("p",[s._v("Fabric 支持把一些参数项与业务代码分离，即通过配置文件来管理它们，例如前面提到的密码和私钥文件，可写在配置文件中，避免与代码耦合。")]),s._v(" "),a("p",[s._v("Fabric 基本沿用了 Invoke 的配置文件体系（官方文档中列出了 9 层），同时增加了一些跟 SSH 相关的配置项。支持的文件格式有 .yaml、.yml、.json 与 .py（按此次序排优先级），推荐使用 yaml 格式（后缀可简写成 yml）。")]),s._v(" "),a("p",[s._v("其中，比较常用的配置文件有：")]),s._v(" "),a("ul",[a("li",[s._v("系统级的配置文件："),a("code",[s._v("/etc/fabric.yml")])]),s._v(" "),a("li",[s._v("用户级的配置文件："),a("code",[s._v("~/.fabric.yml")]),s._v("（Windows 在 "),a("code",[s._v("C:\\Users\\xxx")]),s._v(" 下）")]),s._v(" "),a("li",[s._v("项目级的配置文件："),a("code",[s._v("/myproject/fabric.yml")])])]),s._v(" "),a("p",[s._v("以上文件的优先级递减，由于我的本地开发机器是 Windows 系统，为了方便，我在用户目录建一个 "),a("code",[s._v(".fabric.yml")]),s._v(" 文件，内容如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# filename:.fabric.yml")]),s._v("\n\nuser: root\nconnect_kwargs:\n  password: xxxx\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 若用密钥，则如下")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  key_filename:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#    - your_key_file")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("我们把用户名和密码抽离出来了，所以脚本中就可以删掉这些内容：")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文件名：fabfile.py")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Connection\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" task\n\nhost_ip "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'47.xx.xx.xx'")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器地址")]),s._v("\ncmd "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'date'")]),s._v("             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Shell 命令，查询服务器上的时间")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@task")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n    Get date from remote host.\n    """')]),s._v("\n    con "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host_ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    result "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" con"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cmd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" hide"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("然后，在命令行中执行：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" fab "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("\nTue Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":33:38 CST "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("配置文件中还可以设置很多参数，详细可"),a("a",{attrs:{href:"https://docs.fabfile.org/en/2.5/concepts/configuration.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("查看文档"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"网络网关"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络网关"}},[s._v("#")]),s._v(" 网络网关")]),s._v(" "),a("p",[s._v("如果远程服务是网络隔离的，无法直接被访问到（处在不同局域网），这时候需要有网关/代理/隧道，这个中间层的机器通常被称为跳板机或堡垒机。")]),s._v(" "),a("p",[s._v("Fabric 中有两种网关解决方案，对应到 OpenSSH 客户端的两种选项：")]),s._v(" "),a("ul",[a("li",[s._v("ProxyJump：简单，开销少，可嵌套")]),s._v(" "),a("li",[s._v("ProxyCommand：开销大，不可嵌套，更灵活")])]),s._v(" "),a("p",[s._v("在创建 Fabric 的 Connection 对象时，可通过指定 gateway 参数来应用这两种方案。")]),s._v(" "),a("p",[s._v("ProxyJump 方式就是在一个 Connection 中嵌套一个 Connection  作为前者的网关，后者使用 SSH 协议的 "),a("code",[s._v("direct-tcpip")]),s._v(" 为前者打开与实际远程主机的连接，而且后者还可以继续嵌套使用自己的网关。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" fabric "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Connection\n\nc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'internalhost'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" gateway"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Connection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'gatewayhost'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("ProxyCommand 方式是客户端在本地用 ssh 命令（类似 "),a("code",[s._v("ssh -W %h:%p gatewayhost")]),s._v("），创建一个子进程，该子进程与服务端进行通信，同时它能读取标准输入和输出。")]),s._v(" "),a("p",[s._v("这部分的实现细节分别在 "),a("code",[s._v("paramiko.channel.Channel")]),s._v(" 和 "),a("code",[s._v("paramiko.proxy.ProxyCommand")]),s._v("，除了在参数中指定，也可以在 Fabric 支持的配置文件中定义。更多细节，请"),a("a",{attrs:{href:"https://docs.fabfile.org/en/2.5/concepts/networking.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("查阅文档"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("本文把 Fabric 常见的几种用法都整理了一下，原因是 Fabric 之前对 Python3 的不兼容，导致出现了不同的分支。而网上关于 Fabric 的文章，甚至是最近两年出版的书籍，都是基于 Fabric3（非官方版）的，显然已经过时了。本文针对最新的官方文档，梳理出了较为全面的知识点。更详细的用法，还是得仔细研读官方的英文文档。")]),s._v(" "),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://www.fabfile.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Fabric"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("《Python自动化运维：技术与最佳实践》")])]),s._v(" "),a("p",[s._v("（完）")])])}),[],!1,null,null,null);t.default=e.exports}}]);