(window.webpackJsonp=window.webpackJsonp||[]).push([[273],{1166:function(s,a,t){"use strict";t.r(a);var r=t(1),v=Object(r.a)({},(function(){var s=this,a=s.$createElement,r=s._self._c||a;return r("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[r("h1",{attrs:{id:"持久化之-rbd"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#持久化之-rbd"}},[s._v("#")]),s._v(" 持久化之 RBD")]),s._v(" "),r("h2",{attrs:{id:"什么是-rdb"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#什么是-rdb"}},[s._v("#")]),s._v(" 什么是 RDB")]),s._v(" "),r("p",[s._v("RDB：Redis Databases")]),s._v(" "),r("ul",[r("li",[s._v("持久化实现的方式之一")]),s._v(" "),r("li",[s._v("在指定时间间隔后，将内存中的数据集快照写入数据库")]),s._v(" "),r("li",[s._v("在恢复的时候，直接读取快照文件，进行数据恢复")]),s._v(" "),r("li",[s._v("默认情况下，Redis 将 RDB 保存在 dump.rdb 文件中，可以在配置文件中自定义")])]),s._v(" "),r("p",[r("img",{attrs:{src:t(618),alt:"rdb"}})]),s._v(" "),r("h2",{attrs:{id:"工作原理"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#工作原理"}},[s._v("#")]),s._v(" 工作原理")]),s._v(" "),r("p",[s._v("先了解下 RDB 的两个命令：save 和 bgsave")]),s._v(" "),r("h3",{attrs:{id:"save-命令"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#save-命令"}},[s._v("#")]),s._v(" save 命令")]),s._v(" "),r("ul",[r("li",[s._v("使用 save 命令，会直接调用 rdbsave 函数，立刻对当前内存中的数据进行持久化")]),s._v(" "),r("li",[s._v("会阻塞 Redis 主线程，直到数据同步保存完成，不会接收其他操作")]),s._v(" "),r("li",[s._v("若 Redis 数据非常多时，save 执行的速度会非常慢")])]),s._v(" "),r("h3",{attrs:{id:"bgsave-命令"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#bgsave-命令"}},[s._v("#")]),s._v(" bgsave 命令")]),s._v(" "),r("ul",[r("li",[s._v("会 fork 一个子进程，负责调用 rdbsave 函数")]),s._v(" "),r("li",[s._v("在保存完毕完成后向主线程发送信号通知主进程保存完毕")]),s._v(" "),r("li",[s._v("主进程可以处理其他客户端操作")])]),s._v(" "),r("h3",{attrs:{id:"rdb-实现"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#rdb-实现"}},[s._v("#")]),s._v(" RDB 实现")]),s._v(" "),r("p",[r("img",{attrs:{src:t(619),alt:"rdb"}})]),s._v(" "),r("p",[s._v("在进行 RDB 的时候，Redis 的主线程是不会做 io 操作的，主线程会 fork 一个子线程来完成该操作；")]),s._v(" "),r("ul",[r("li",[s._v("Redis 调用 fork，同时拥有父进程和子进程")]),s._v(" "),r("li",[s._v("子进程将数据集写入到一个临时 RDB 文件中")]),s._v(" "),r("li",[s._v("当子进程完成对新 RDB 文件的写入时，Redis 用新 RDB 文件替换原来的 RDB 文件，并删除旧的 RDB 文件")]),s._v(" "),r("li",[s._v("这种工作方式使得 Redis 可以从写时复制（copy-on-write）机制中获益(因为是使用子进程进行写操作，而父进程依然可以接收来自客户端的请求)")])]),s._v(" "),r("h2",{attrs:{id:"触发机制"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#触发机制"}},[s._v("#")]),s._v(" 触发机制")]),s._v(" "),r("ul",[r("li",[s._v("save 的规则满足的情况下，会自动触发 RDB 原则")]),s._v(" "),r("li",[s._v("执行 flushall 命令，也会触发我们的 RDB 原则")]),s._v(" "),r("li",[s._v("退出 redis，也会自动产生 RDB 文件")])]),s._v(" "),r("p",[r("img",{attrs:{src:t(620),alt:"rdb"}})]),s._v(" "),r("p",[r("strong",[s._v("恢复 RDB 文件")]),s._v("：")]),s._v(" "),r("ul",[r("li",[s._v("只需要将 RDB 文件放在 Redis 启动目录就行，Redis 启动会自动检查 dump.rdb 恢复其中的数据")]),s._v(" "),r("li",[s._v("查看需要存放的位置")])]),s._v(" "),r("div",{staticClass:"language-shell line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-shell"}},[r("code",[r("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),r("span",{pre:!0,attrs:{class:"token operator"}},[r("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" config get "),r("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dir"')]),s._v("\n"),r("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[s._v('"usr/local/bin"')]),s._v("\n")])]),s._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[s._v("1")]),r("br"),r("span",{staticClass:"line-number"},[s._v("2")]),r("br"),r("span",{staticClass:"line-number"},[s._v("3")]),r("br")])]),r("h2",{attrs:{id:"rdb-优缺点"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#rdb-优缺点"}},[s._v("#")]),s._v(" RDB 优缺点")]),s._v(" "),r("p",[r("strong",[s._v("优点")]),s._v(":")]),s._v(" "),r("ul",[r("li",[s._v("适合大规模的数据恢复")]),s._v(" "),r("li",[s._v("对数据的完整性要求不高")])]),s._v(" "),r("p",[r("strong",[s._v("缺点")]),s._v(":")]),s._v(" "),r("ul",[r("li",[s._v("需要一定的时间间隔进行操作，如果 Redis 意外宕机了，这个最后一次修改的数据就没有了")]),s._v(" "),r("li",[s._v("fork 进程的时候，会占用一定的内容空间")])]),s._v(" "),r("p",[s._v("（完）")])])}),[],!1,null,null,null);a.default=v.exports},618:function(s,a,t){s.exports=t.p+"assets/img/rdb3.df56f130.png"},619:function(s,a,t){s.exports=t.p+"assets/img/rbd1.04a90d9f.png"},620:function(s,a,t){s.exports=t.p+"assets/img/rdb2.69d7c099.png"}}]);